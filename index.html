<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Thi Online - Đảo Toàn Diện</title>
    <style>
        :root { --p: #2c3e50; --s: #27ae60; --d: #e74c3c; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .exam-title { text-align: center; color: var(--p); font-size: 24px; font-weight: bold; margin-bottom: 30px; border-bottom: 3px solid var(--p); padding-bottom: 10px; }
        .box { background: #fff; border: 2px solid var(--p); border-radius: 10px; padding: 30px; margin-bottom: 15px; text-align: center; cursor: pointer; transition: 0.3s; font-size: 18px; font-weight: bold; }
        .box:hover { background: var(--p); color: white; }
        .question-item { background: #fff; border: 1px solid #ddd; padding: 20px; margin-bottom: 15px; border-radius: 8px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-submit { background: var(--s); color: white; width: 100%; font-size: 18px; }
        .btn-view { background: #3498db; color: white; }
        #result-screen { display: none; text-align: center; }
        .score-big { font-size: 50px; color: #e67e22; margin: 10px 0; }
        .correct-ans { color: var(--s); font-weight: bold; }
        .wrong-ans { color: var(--d); font-weight: bold; }
        input[type="text"] { padding: 10px; width: 80%; border: 1px solid #ccc; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="exam-title" id="display-title">[Tên đề thi]</div>

    <div id="main-menu">
        <div class="box" onclick="initSection('choice')">Trắc nghiệm 4 lựa chọn</div>
        <div class="box" onclick="initSection('tf')">Đúng/Sai</div>
        <div class="box" onclick="initSection('short')">Trả lời ngắn</div>
    </div>

    <div id="quiz-area" style="display:none;">
        <div id="questions-container"></div>
        <button class="btn btn-submit" onclick="grade()">Nộp bài</button>
    </div>

    <div id="result-screen">
        <h2>KẾT QUẢ</h2>
        <div class="score-big" id="score-text">0/10</div>
        <div class="btn-group">
            <button class="btn btn-view" onclick="renderReview('correct')">Coi đáp án đúng</button>
            <button class="btn btn-view" onclick="renderReview('wrong')">Coi đáp án sai</button>
            <button class="btn btn-view" onclick="renderReview('all')">Coi toàn bộ theo đề gốc</button>
        </div>
        <div id="review-list" style="text-align: left; margin-top: 25px;"></div>
        <button class="btn" style="background:#7f8c8d; color:white;" onclick="location.reload()">Quay lại</button>
    </div>
</div>

<script>
// --- DỮ LIỆU GIÁO VIÊN (Giữ nguyên định dạng bạn muốn) ---
const RawData = {
    title: "KIỂM TRA LỊCH SỬ - HỆ THỐNG ĐẢO TOÀN DIỆN",
    choice_raw: `
Câu 71: Đọc đoạn tư liệu sau đây, trong mỗi ý A, B, C, D, học sinh chọn đúng hoặc sai.
“…Rạng sáng ngày 23/9/1945, được sự giúp đỡ của quân đội Anh, thực dân Pháp chính thức bội ước, cho hàng ngàn lính nổ súng tấn công, đánh chiếm Sài Gòn, chính thức mở ra cuộc chiến tranh xâm lược nước ta lần thứ hai.  “Sơn hà nguy biến”, Xứ ủy, Ủy ban nhân dân, Ủy ban Kháng chiến Nam bộ và Đại diện Tổng bộ Việt Minh đã thống nhất ra Lời kêu gọi  đồng bào cầm vũ khí đánh đuổi quân xâm lược. Nam Bộ bước vào cuộc chiến trực diện với kẻ thù.
Ngày 26/9/1945, qua làn sóng của Đài Tiếng nói Việt Nam, Chủ tịch Hồ chí Minh kêu gọi; “Hỡi đồng bào Nam bộ! Nước ta vừa tranh quyền độc lập, thì đã gặp nạn ngoại xâm... Tôi chắc và đồng bào cả nước đều chắc vào lòng kiên quyết ái quốc của đồng bào Nam bộ. Chúng ta nên nhớ lời nói oanh liệt của nhà đại cách mạng Pháp “thà chết tự do còn hơn sống nô lệ” ... Chúng ta nhất định thắng lợi vì chúng ta có lực lượng đoàn kết của cả quốc dân. Chúng ta nhất định thắng lợi vì cuộc đấu tranh của chúng ta là chính đáng”..”.
( Trích Nam Bộ kháng chiến - Hào khí và quyết tâm bảo vệ  nền độc lập, tự do của nước nhà, báo điện tử Đảng bộ Tỉnh Quảng Ngãi, 9/2021)
a) Thực dân Anh vào Đông Dương giải giáp phát xít Nhật với danh nghĩa đại diện của phe Đồng minh.
b) Kẻ thù nguy hiểm nhất của nước Việt Nam Dân chủ Cộng hòa sau cách mạng tháng Tám là thực dân Pháp.
c) Trước dã tâm xâm lược của kẻ thù, nhân dân Nam Bộ kiên trì đấu tranh bằng con đường hòa bình để giữ vững thành quả cách mạng.
d) Trong lời kêu gọi ngày 26/9/1945, Chủ tịch Hồ chí Minh kêu gọi toàn quốc kháng chiến để bảo vệ nền độc lập nước nhà.
Câu 72: Đọc đoạn tư liệu sau đây, trong mỗi ý A, B, C, D, học sinh chọn đúng hoặc sai.
Cuộc chiến đấu của quân và dân ta ở tại đô thị [phía Bắc vĩ tuyến 16] suốt gần ba tháng có ý nghĩa rất lớn. Ta đã chủ động mở đầu cuộc kháng chiến toàn quốc đúng lúc, khi khả năng hòa hoãn không còn, ta có chuẩn bị và viện binh Pháp còn lênh đênh trên biển. Ngoài việc làm tiêu hao, tiêu diệt một bộ phận địch, ta đã bảo vệ an toàn cơ quan đầu não và bảo tồn lực lượng kháng chiến, giành được khoảng thời gian chiến lược quý báu để tiếp tục chuyển đất nước vào thời chiến và đẩy lùi âm mưu đánh nhanh thắng nhanh của địch.
           (Viện Lịch sử quân sự Việt Nam, Lịch sử quân sự Việt Nam, tập 10: Cuộc kháng chiến chống thực dân Pháp (1945 – 1954), NXB Chính trị Quốc gia Sự thật, 2019, tr. 71).
a) Cuộc chiến đấu ở các đô thị phía Bắc vĩ tuyến 16 là thắng lợi quân sự mở đầu của quân dân ta trong cuộc kháng chiến toàn quốc chống thực dân Pháp.
b) Cuộc chiến đấu ở các đô thị phía Bắc vĩ tuyến 16 đã bảo vệ an toàn cơ quan đầu não và những đô thị trọng yếu, tiêu diệt một bộ phận quan trọng sinh lực địch.
c) Nối tiếp cuộc kháng chiến chống thực dân Pháp trở lại xâm lược Nam Bộ (1945), cuộc chiến đấu ở các đô thị phía Bắc vĩ tuyến 16 đã làm phá sản hoàn toàn kế hoạch “đánh nhanh thắng nhanh” của Pháp.
d) Cuộc chiến đấu ở các đô thị phía Bắc vĩ tuyến 16 và chiến dịch Biên giới thu đông 1950 đều là những chiến dịch do ta chủ động tiến hành, đạt được mục tiêu ban đầu đề ra.
Câu 73: Đọc đoạn tư liệu sau đây, trong mỗi ý A, B, C, D, học sinh chọn đúng hoặc sai.
Chiến dịch Việt Bắc là chiến dịch phản công lớn đầu tiên của lực lượng vũ trang cách mạng. Chiến thắng Việt Bắc cùng với thắng lợi trên các chiến trường khác trong thu đông năm 1947 đã đưa cuộc kháng chiến chống thực dân Pháp của nhân dân ta sang giai đoạn lịch sử mới.
                     (Nguyễn Quang Ngọc (Chủ biên), Tiến trình lịch sử Việt Nam, NXB Giáo dục, 2007, tr.313)
a) Chiến dịch Việt Bắc là chiến dịch phản công lớn đầu tiên và cũng là thắng lợi quân sự đầu tiên của quân dân ta trong kháng chiến chống Pháp.
b) Chiến dịch Việt Bắc góp phần đưa cuộc kháng chiến chống Pháp của nhân dân ta sang giai đoạn lịch sử mới vì đã làm thất bại hoàn toàn kế hoạch “đánh nhanh thắng nhanh” của thực dân Pháp.
c) Cuộc chiến đấu ở các đô thị phía Bắc vĩ tuyến 16 (cuối 1946 – đầu 1947) và chiến dịch Việt Bắc thu đông 1947 có sự khác biệt về địa hình tác chiến, lực lượng lãnh đạo và lực lượng chủ lực tham gia.
d) Chiến dịch Việt Bắc thu đông 1947 và chiến dịch Biên giới thu đông năm 1950 đều là những chiến dịch ta chủ động tấn công, đạt được mục tiêu.
Câu 74. Đọc đoạn sau: Bảy năm sau sự kiện Điện Biên Phủ, ký giả người Pháp J. Roa, trong cuốn sách Trận Điện Biên Phủ ghi nhận: “Trong toàn thế giới, trận Oa-téc-lô cũng ít tiếng vang hơn... Đó là một trong những thất bại lớn của phương Tây, báo hiệu sự tan rã của các thuộc địa và sự cáo chung của một nền cộng hòa. Tiếng sấm của sự kiện Điện Biên Phủ vẫn còn đang âm vang”2. 
Cũng với nhận định như thế, Bernard Fall, nhà sử học Mỹ gốc Pháp viết: “Chúng ta không có quyền được quên cuộc chiến này. Dù ta muốn hay không muốn, cuộc chiến tranh đó vẫn còn ảnh hưởng đến chúng ta nhiều chục năm nữa”.3
(2, 3. Dẫn theo: Đỗ Thiện, Đinh Kim Khánh: Tiếng sấm Điện Biên Phủ, Nxb QĐND, H, 1984, tr. 284, 28)
Các dữ kiện trên cho biết: trong mỗi ý A, B, C, D, học sinh chọn đúng hoặc sai.
a) Trận Trận Điện Biên Phủ năm 1954, được đánh giá là “Lừng lẫy năm châu chấn động địa cầu”.
b) Trận Điện Biên Phủ là thắng lợi quân sự quyết định, buộc Pháp phải kí Hiệp định Giơnevơ cộng nhận độc lập chủ quyền và toàn vẹn lãnh thổ cho nhân dân 3 nước Đông Dương.
c) Làm thất bại âm mưu kéo dài chiến tranh để tìm cách thay chân Pháp trong cuộc chiến tranh Đông Dương của Mĩ.
d) Là chiến dịch tấn công lớn đầu tiên của quân ta, làm xoay chuyển cục diện chiến tranh.
Câu 75. Đọc đoạn tư liệu sau đây:
"Đế quốc Mỹ và chính quyền Sài Gòn do Ngô Đình Diệm đứng đầu đã trắng trợn phá bỏ Hiệp định Giơ-ne-vơ, thẳng tay đàn áp, khủng bố, mở các chiến dịch "tố cộng, diệt cộng" bằng cái gọi là sức mạnh của quân lực cộng hoà,...
... Để bảo vệ sinh mạng và quyền lợi cơ bản của mình, nhân dân miền Nam dưới sự lãnh đạo của Đảng không có con đường nào khác là phải đứng lên đánh đổ chế độ độc tài phát xít của Mỹ và tay sai, giải phóng hoàn toàn miền Nam, thực hiện thống nhất nước nhà".
                           (Lê Mậu Hãn, Sức mạnh dân tộc của cách mạng Việt Nam dưới ánh sáng tư tưởng Hồ Chí Minh, NXB Chính trị quốc gia Sự thật, Hà Nội, 2017, tr.294)
a) Sau Hiệp định Giơ-ne-vơ năm 1954 về Đông Dương, Pháp dựng lên chính quyền tay sai Ngô Đình Diệm cốt là để trì hoãn việc thống nhất đất nước ở Việt Nam.
b) Từ thực tiễn đất nước và sự phá hoại của Mỹ và chính quyền Ngô Đình Diệm, nếu chỉ sử dụng hình thức đấu tranh hòa bình sẽ không thể thống nhất Tổ quốc.
c) Đặc điểm lớn nhất và độc đáo nhất của cách mạng Việt Nam (1954 - 1975) là một đảng thống nhất lãnh đạo cả nước thực hiện đồng thời nhiều nhiệm vụ chiến lược.
d) Chiến dịch Hồ Chí Minh kết thúc thắng lợi đã hoàn thành sự nghiệp kháng chiến chống Mỹ, cứu nước; đồng thời mở ra kỉ nguyên mới cho cả dân tộc.
Câu 76. Đọc các đoạn tư liệu sau:
“Ngày 2-1-1963, địch sử dụng khoảng 7 tiểu đoàn bộ binh, kể cả lính dù, cùng hàng chục xe tăng lội nước M.113, tàu chiến và hơn 20 máy bay tiến công vào Ấp Bắc (xã Tân Phú Trung, Cai Lậy, Mỹ Tho). Đây là địa bàn chiến lược nằm ở trung tâm của đồng bằng sông Cửu Long.
Quán triệt phương châm bám sát trận địa, chờ khi địch tiến sát bộ đội ta mới nổ súng. Suốt một ngày tiến công, các mũi tiến công của địch từ nhiều hướng vào Ấp Bắc đều bị bẻ gãy.”
     		(Tiến trình lịch sử Việt Nam, NXB Giáo dục, năm 2003, tr.340.)
a) Thủ đoạn của Mỹ khi đánh vào Ấp Bắc đã dùng chiến thuật quân sự trực thăng vận”, “ thiết xa vận”.
b) Chiến thắng Ấp Bắc của quân dân ta đã làm phá sản hoàn toàn “Chiến tranh đặc biệt” của Mỹ.
c) Chiến thắng Ấp Bắc của quân dân ta đã mở ra khả năng đánh bại “Chiến tranh đặc biệt” của Mỹ.
d) Cuộc tấn công vào Ấp Bắc ở miền Nam Việt Nam nằm trong chiến lược “Chiến tranh cục bộ” của Mỹ.
Câu 77. Đọc các đoạn tư liệu sau:
“Đêm 30 rạng ngày 31-1-1968 (đêm giao thừa Tết Mậu Thân), lực lượng vũ trang cách mạng và nhân dân miền Nam đồng loạt tiến công địch ở khắp các thành phố, thị xã.”
 (Tiến trình lịch sử Việt Nam, NXB Giáo dục, năm 2003, tr.353.)
a) Năm 1968, quân dân Việt Nam mở cuộc Tổng tiến công và nổi dậy trên toàn miền Nam, trọng tâm là ở các đô thị.
b) Thắng lợi của cuộc Tổng tiến công và nổi dậy Mậu Thân năm 1968 buộc Mỹ phải “phi Mỹ hóa” chiến tranh xâm lược và chấp nhận đàm phán ở Pari.
c) Thắng lợi của cuộc Tổng tiến công và nổi dậy Mậu Thân năm 1968 buộc Mỹ phải “Mỹ hóa” trở lại chiến tranh xâm lược xâm lược Việt Nam.
d) Thắng lợi của cuộc Tổng tiến công và nổi dậy Mậu Thân năm 1968, buộc Mỹ phải thừa nhận thất bại của chiến lược “Chiến tranh đặc biệt”.
Câu 78. Đọc đoạn tư liệu sau
“Vào lúc 17 giờ ngày 26/4, quân ta đã nổ súng mở đầu chiến dịch, năm cánh quân của ta đã vượt qua tuyến phòng thủ của địch để tiến vào trung tâm Sài Gòn, đánh chiếm các cơ quan đầu não của chúng. 10 giờ 45 phút ngày 30/4, xe tăng và bộ binh của ta tiến vào Dinh Độc Lập, bắt toàn bộ Nội các của Sài Gòn, Dương Văn Minh vừa lên chức tổng thống ngày 28/4 đã phải tuyên bố đầu hàng quân ta không điều kiện. Đến 11 giờ 30 phút cùng ngày, lá cờ cách mạng tung bay trên Dinh Độc Lập, báo hiệu sự toàn thắng của chiến dịch Hồ Chí Minh lịch sử”.
(Lịch sử, ý nghĩa ngày giải phóng miền Nam, thống nhất đất nước 30/4, Trang thông tin điện tử Đảng bộ thành phố Đà Lạt)
a) Chiến dịch Hồ Chí Minh là chiến dịch mở đầu cuộc Tổng tiến công và nổi dậy Mùa Xuân năm 1975.
b) Ngày 30/4/1975, tập đoàn Ngô Đình Diệm đã đầu hàng quân ta không điều kiện.
c) Chiến dịch Hồ Chí Minh đã kết thúc 30 năm kháng chiến chống Mỹ cứu nước của quân dân Việt Nam.
d) Ngày 30/4/1975 là ngày giải phóng hoàn toàn miền Nam, thống nhất đất nước. 
    `,
    choice_ans: "69C", 

    tf_raw: `
Câu 71: Về tình hình Nam Bộ sau ngày 23/9/1945:
a) Thực dân Anh vào giải giáp quân Nhật với danh nghĩa Đồng minh.
b) Pháp là kẻ thù nguy hiểm nhất sau Cách mạng tháng Tám.
c) Nhân dân Nam Bộ chỉ đấu tranh bằng con đường hòa bình.
d) Chủ tịch Hồ Chí Minh kêu gọi toàn quốc kháng chiến ngay lúc này.
    `,
    tf_ans: "71-ĐĐSS",

    short_raw: `60: Pháp xâm lược VN năm nào?`,
    short_ans: "60-1858"
};

let parsed = { choice: [], tf: [], short: [] };
let activeMode = '';
let currentQ = [];
let studentAns = {};

function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

function parseAll() {
    document.getElementById('display-title').innerText = `[${RawData.title}]`;
    
    // 1. Trắc nghiệm
    const cAnsMap = {};
    const cMatches = RawData.choice_ans.match(/(\d+)([A-D])/gi) || [];
    cMatches.forEach(item => {
        let num = item.match(/\d+/)[0];
        let char = item.match(/[A-D]/i)[0].toUpperCase();
        cAnsMap[num] = "ABCD".indexOf(char);
    });
    const cRegex = /(?:Câu\s*(\d+)[\.:]|(\b\d+)[\.:])([\s\S]*?)A\.\s*([\s\S]*?)B\.\s*([\s\S]*?)C\.\s*([\s\S]*?)D\.\s*([\s\S]*?)(?=(?:Câu\s*\d+[\.:]|\b\d+[\.:])|$)/gi;
    let m;
    while ((m = cRegex.exec(RawData.choice_raw)) !== null) {
        let qNum = m[1] || m[2];
        parsed.choice.push({ id: 'c'+qNum, num: qNum, q: m[3].trim(), options: [m[4].trim(), m[5].trim(), m[6].trim(), m[7].trim()], correct: cAnsMap[qNum] });
    }

    // 2. Đúng/Sai
    const tfAnsMap = {};
    const tfMatches = RawData.tf_ans.match(/(\d+)-([ĐS]{4})/gi) || [];
    tfMatches.forEach(item => { let p = item.split('-'); tfAnsMap[p[0]] = p[1].split('').map(c => c === 'Đ'); });
    const tfRegex = /(?:Câu\s*(\d+)[\.:]|(\b\d+)[\.:])([\s\S]*?)a\)\s*([\s\S]*?)b\)\s*([\s\S]*?)c\)\s*([\s\S]*?)d\)\s*([\s\S]*?)(?=(?:Câu\s*\d+[\.:]|\b\d+[\.:])|$)/gi;
    while ((m = tfRegex.exec(RawData.tf_raw)) !== null) {
        let qNum = m[1] || m[2];
        parsed.tf.push({ id: 'tf'+qNum, num: qNum, q: m[3].trim(), sub: [m[4].trim(), m[5].trim(), m[6].trim(), m[7].trim()], correct: tfAnsMap[qNum] });
    }

    // 3. Ngắn
    const sAnsMap = {};
    const sMatches = RawData.short_ans.match(/(\d+)-([^\s]+)/gi) || [];
    sMatches.forEach(item => { let p = item.split('-'); sAnsMap[p[0]] = p[1]; });
    const sRegex = /(?:Câu\s*(\d+)[\.:]|(\b\d+)[\.:])([\s\S]*?)(?=(?:Câu\s*\d+[\.:]|\b\d+[\.:])|$)/gi;
    while ((m = sRegex.exec(RawData.short_raw)) !== null) {
        let qNum = m[1] || m[2];
        parsed.short.push({ id: 's'+qNum, num: qNum, q: m[3].trim(), correct: sAnsMap[qNum] });
    }
}

function initSection(mode) {
    if (parsed[mode].length === 0) return alert("Không có câu hỏi!");
    activeMode = mode;
    
    currentQ = parsed[mode].map(q => {
        let newQ = JSON.parse(JSON.stringify(q)); // Deep copy
        if (mode === 'choice') {
            let opts = q.options.map((text, idx) => ({ text, isCorrect: idx === q.correct }));
            newQ.shuffledOptions = shuffle(opts);
        } else if (mode === 'tf') {
            let subs = q.sub.map((text, idx) => ({ text, isCorrect: q.correct[idx] }));
            newQ.shuffledSubs = shuffle(subs);
        }
        return newQ;
    });
    currentQ = shuffle(currentQ);

    document.getElementById('main-menu').style.display = 'none';
    document.getElementById('quiz-area').style.display = 'block';
    renderQuiz();
}

function renderQuiz() {
    const container = document.getElementById('questions-container');
    container.innerHTML = '';
    currentQ.forEach((q, idx) => {
        let html = `<div class="question-item"><p><b>Câu ${idx+1}:</b> ${q.q}</p>`;
        if (activeMode === 'choice') {
            q.shuffledOptions.forEach((opt, i) => {
                html += `<label style="display:block;margin:5px 0;"><input type="radio" name="${q.id}" value="${opt.isCorrect}"> ${String.fromCharCode(65+i)}. ${opt.text}</label>`;
            });
        } else if (activeMode === 'tf') {
            q.shuffledSubs.forEach((s, i) => {
                html += `<div style="margin:10px 0 10px 20px;">• ${s.text} 
                <label><input type="radio" name="${q.id}_${i}" value="${s.isCorrect}"> Đ</label>
                <label style="margin-left:10px;"><input type="radio" name="${q.id}_${i}" value="${!s.isCorrect}"> S</label></div>`;
            });
        } else if (activeMode === 'short') {
            html += `<input type="text" id="input_${q.id}" placeholder="Nhập câu trả lời...">`;
        }
        container.innerHTML += html + `</div>`;
    });
}

function grade() {
    let rawScore = 0; let pPerQ = 10 / currentQ.length;
    currentQ.forEach(q => {
        studentAns[q.id] = { points: 0, display: '', tf_results: [] };
        if (activeMode === 'choice') {
            let sel = document.querySelector(`input[name="${q.id}"]:checked`);
            if (sel) {
                let isRight = (sel.value === 'true');
                studentAns[q.id].display = sel.parentElement.innerText.trim();
                if (isRight) { studentAns[q.id].points = pPerQ; rawScore += pPerQ; }
            }
        } else if (activeMode === 'tf') {
            let count = 0;
            q.shuffledSubs.forEach((s, i) => {
                let sel = document.querySelector(`input[name="${q.id}_${i}"]:checked`);
                let userChoice = sel ? (sel.value === 'true') : null;
                studentAns[q.id].tf_results.push({ text: s.text, correct: s.isCorrect, user: userChoice });
                if (userChoice === true) count++;
            });
            let ratio = [0, 0.1, 0.2, 0.5, 1][count] || 0;
            studentAns[q.id].points = pPerQ * ratio; rawScore += studentAns[q.id].points;
        } else if (activeMode === 'short') {
            let v = document.getElementById(`input_${q.id}`).value.trim();
            studentAns[q.id].val = v;
            if (v.toLowerCase() === q.correct.toLowerCase()) { studentAns[q.id].points = pPerQ; rawScore += pPerQ; }
        }
    });
    document.getElementById('quiz-area').style.display = 'none';
    document.getElementById('result-screen').style.display = 'block';
    document.getElementById('score-text').innerText = (Math.round(rawScore * 10) / 10) + "/10";
}

function renderReview(mode) {
    const div = document.getElementById('review-list'); div.innerHTML = '';
    const list = (mode === 'all') ? parsed[activeMode] : currentQ;
    const maxP = 10 / list.length;

    list.forEach((q, idx) => {
        const ans = studentAns[q.id];
        if (mode === 'correct' && ans.points < maxP * 0.9) return;
        if (mode === 'wrong' && ans.points >= maxP * 0.9) return;

        let html = `<div class="question-item"><p><b>Câu ${q.num}:</b> ${q.q}</p>`;
        if (activeMode === 'choice') {
            q.options.forEach((opt, i) => {
                let cls = (i === q.correct) ? 'correct-ans' : '';
                html += `<div class="${cls}">${String.fromCharCode(65+i)}. ${opt} ${i === q.correct ? '✓' : ''}</div>`;
            });
            html += `<p>Bạn chọn: <span class="${ans.points > 0 ? 'correct-ans' : 'wrong-ans'}">${ans.display || '(Trống)'}</span></p>`;
        } else if (activeMode === 'tf') {
            // Hiển thị lại đúng thứ tự a, b, c, d của đề gốc khi review
            q.sub.forEach((sText, i) => {
                let isRight = q.correct[i];
                // Tìm xem trong lúc làm bài, học sinh đã chọn gì cho ý này
                let work = ans.tf_results.find(r => r.text === sText);
                let userS = (work && work.user !== null) ? (work.user ? 'Đ' : 'S') : '_';
                let check = work ? (work.user === true) : false;
                html += `<div>• ${sText} -> <b class="correct-ans">${isRight?'Đ':'S'}</b> (Bạn: <span class="${check?'':'wrong-ans'}">${userS}</span>)</div>`;
            });
        } else if (activeMode === 'short') {
            html += `<p>Bạn điền: <span class="${ans.points > 0 ? 'correct-ans' : 'wrong-ans'}">${ans.val || '(Trống)'}</span></p>`;
            html += `<p class="correct-ans">Đáp án đúng: ${q.correct}</p>`;
        }
        div.innerHTML += html + `</div>`;
    });
}
parseAll();
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Thi Online - Đảo Toàn Diện</title>
    <style>
        :root { --p: #2c3e50; --s: #27ae60; --d: #e74c3c; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .exam-title { text-align: center; color: var(--p); font-size: 24px; font-weight: bold; margin-bottom: 30px; border-bottom: 3px solid var(--p); padding-bottom: 10px; }
        .box { background: #fff; border: 2px solid var(--p); border-radius: 10px; padding: 30px; margin-bottom: 15px; text-align: center; cursor: pointer; transition: 0.3s; font-size: 18px; font-weight: bold; }
        .box:hover { background: var(--p); color: white; }
        .question-item { background: #fff; border: 1px solid #ddd; padding: 20px; margin-bottom: 15px; border-radius: 8px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-submit { background: var(--s); color: white; width: 100%; font-size: 18px; }
        .btn-view { background: #3498db; color: white; }
        #result-screen { display: none; text-align: center; }
        .score-big { font-size: 50px; color: #e67e22; margin: 10px 0; }
        .correct-ans { color: var(--s); font-weight: bold; }
        .wrong-ans { color: var(--d); font-weight: bold; }
        input[type="text"] { padding: 10px; width: 80%; border: 1px solid #ccc; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="exam-title" id="display-title">[Tên đề thi]</div>

    <div id="main-menu">
        <div class="box" onclick="initSection('choice')">Trắc nghiệm 4 lựa chọn</div>
        <div class="box" onclick="initSection('tf')">Đúng/Sai</div>
        <div class="box" onclick="initSection('short')">Trả lời ngắn</div>
    </div>

    <div id="quiz-area" style="display:none;">
        <div id="questions-container"></div>
        <button class="btn btn-submit" onclick="grade()">Nộp bài</button>
    </div>

    <div id="result-screen">
        <h2>KẾT QUẢ</h2>
        <div class="score-big" id="score-text">0/10</div>
        <div class="btn-group">
            <button class="btn btn-view" onclick="renderReview('correct')">Coi đáp án đúng</button>
            <button class="btn btn-view" onclick="renderReview('wrong')">Coi đáp án sai</button>
            <button class="btn btn-view" onclick="renderReview('all')">Coi toàn bộ theo đề gốc</button>
        </div>
        <div id="review-list" style="text-align: left; margin-top: 25px;"></div>
        <button class="btn" style="background:#7f8c8d; color:white;" onclick="location.reload()">Quay lại</button>
    </div>
</div>

<script>
// --- DỮ LIỆU GIÁO VIÊN (Giữ nguyên định dạng bạn muốn) ---
const RawData = {
    title: "KIỂM TRA LỊCH SỬ - HỆ THỐNG ĐẢO TOÀN DIỆN",
    choice_raw: `
69. Sau cuộc tổng tiến công và nổi dậy xuân Mậu Thân năm 1968, Mỹ tuyên bố “phi Mỹ hóa” chiến tranh là thừa nhận thất bại của chiến lược nào?
A. Chiến tranh một phía.                               
B. Chiến tranh đặc biệt.
C. Chiến tranh cục bộ.                                                                
D. Việt Nam hóa chiến tranh.
    `,
    choice_ans: "69C", 

    tf_raw: `
Câu 71: Về tình hình Nam Bộ sau ngày 23/9/1945:
a) Thực dân Anh vào giải giáp quân Nhật với danh nghĩa Đồng minh.
b) Pháp là kẻ thù nguy hiểm nhất sau Cách mạng tháng Tám.
c) Nhân dân Nam Bộ chỉ đấu tranh bằng con đường hòa bình.
d) Chủ tịch Hồ Chí Minh kêu gọi toàn quốc kháng chiến ngay lúc này.
    `,
    tf_ans: "71-ĐĐSS",

    short_raw: `60: Pháp xâm lược VN năm nào?`,
    short_ans: "60-1858"
};

let parsed = { choice: [], tf: [], short: [] };
let activeMode = '';
let currentQ = [];
let studentAns = {};

function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

function parseAll() {
    document.getElementById('display-title').innerText = `[${RawData.title}]`;
    
    // 1. Trắc nghiệm
    const cAnsMap = {};
    const cMatches = RawData.choice_ans.match(/(\d+)([A-D])/gi) || [];
    cMatches.forEach(item => {
        let num = item.match(/\d+/)[0];
        let char = item.match(/[A-D]/i)[0].toUpperCase();
        cAnsMap[num] = "ABCD".indexOf(char);
    });
    const cRegex = /(?:Câu\s*(\d+)[\.:]|(\b\d+)[\.:])([\s\S]*?)A\.\s*([\s\S]*?)B\.\s*([\s\S]*?)C\.\s*([\s\S]*?)D\.\s*([\s\S]*?)(?=(?:Câu\s*\d+[\.:]|\b\d+[\.:])|$)/gi;
    let m;
    while ((m = cRegex.exec(RawData.choice_raw)) !== null) {
        let qNum = m[1] || m[2];
        parsed.choice.push({ id: 'c'+qNum, num: qNum, q: m[3].trim(), options: [m[4].trim(), m[5].trim(), m[6].trim(), m[7].trim()], correct: cAnsMap[qNum] });
    }

    // 2. Đúng/Sai
    const tfAnsMap = {};
    const tfMatches = RawData.tf_ans.match(/(\d+)-([ĐS]{4})/gi) || [];
    tfMatches.forEach(item => { let p = item.split('-'); tfAnsMap[p[0]] = p[1].split('').map(c => c === 'Đ'); });
    const tfRegex = /(?:Câu\s*(\d+)[\.:]|(\b\d+)[\.:])([\s\S]*?)a\)\s*([\s\S]*?)b\)\s*([\s\S]*?)c\)\s*([\s\S]*?)d\)\s*([\s\S]*?)(?=(?:Câu\s*\d+[\.:]|\b\d+[\.:])|$)/gi;
    while ((m = tfRegex.exec(RawData.tf_raw)) !== null) {
        let qNum = m[1] || m[2];
        parsed.tf.push({ id: 'tf'+qNum, num: qNum, q: m[3].trim(), sub: [m[4].trim(), m[5].trim(), m[6].trim(), m[7].trim()], correct: tfAnsMap[qNum] });
    }

    // 3. Ngắn
    const sAnsMap = {};
    const sMatches = RawData.short_ans.match(/(\d+)-([^\s]+)/gi) || [];
    sMatches.forEach(item => { let p = item.split('-'); sAnsMap[p[0]] = p[1]; });
    const sRegex = /(?:Câu\s*(\d+)[\.:]|(\b\d+)[\.:])([\s\S]*?)(?=(?:Câu\s*\d+[\.:]|\b\d+[\.:])|$)/gi;
    while ((m = sRegex.exec(RawData.short_raw)) !== null) {
        let qNum = m[1] || m[2];
        parsed.short.push({ id: 's'+qNum, num: qNum, q: m[3].trim(), correct: sAnsMap[qNum] });
    }
}

function initSection(mode) {
    if (parsed[mode].length === 0) return alert("Không có câu hỏi!");
    activeMode = mode;
    
    currentQ = parsed[mode].map(q => {
        let newQ = JSON.parse(JSON.stringify(q)); // Deep copy
        if (mode === 'choice') {
            let opts = q.options.map((text, idx) => ({ text, isCorrect: idx === q.correct }));
            newQ.shuffledOptions = shuffle(opts);
        } else if (mode === 'tf') {
            let subs = q.sub.map((text, idx) => ({ text, isCorrect: q.correct[idx] }));
            newQ.shuffledSubs = shuffle(subs);
        }
        return newQ;
    });
    currentQ = shuffle(currentQ);

    document.getElementById('main-menu').style.display = 'none';
    document.getElementById('quiz-area').style.display = 'block';
    renderQuiz();
}

function renderQuiz() {
    const container = document.getElementById('questions-container');
    container.innerHTML = '';
    currentQ.forEach((q, idx) => {
        let html = `<div class="question-item"><p><b>Câu ${idx+1}:</b> ${q.q}</p>`;
        if (activeMode === 'choice') {
            q.shuffledOptions.forEach((opt, i) => {
                html += `<label style="display:block;margin:5px 0;"><input type="radio" name="${q.id}" value="${opt.isCorrect}"> ${String.fromCharCode(65+i)}. ${opt.text}</label>`;
            });
        } else if (activeMode === 'tf') {
            q.shuffledSubs.forEach((s, i) => {
                html += `<div style="margin:10px 0 10px 20px;">• ${s.text} 
                <label><input type="radio" name="${q.id}_${i}" value="${s.isCorrect}"> Đ</label>
                <label style="margin-left:10px;"><input type="radio" name="${q.id}_${i}" value="${!s.isCorrect}"> S</label></div>`;
            });
        } else if (activeMode === 'short') {
            html += `<input type="text" id="input_${q.id}" placeholder="Nhập câu trả lời...">`;
        }
        container.innerHTML += html + `</div>`;
    });
}

function grade() {
    let rawScore = 0; let pPerQ = 10 / currentQ.length;
    currentQ.forEach(q => {
        studentAns[q.id] = { points: 0, display: '', tf_results: [] };
        if (activeMode === 'choice') {
            let sel = document.querySelector(`input[name="${q.id}"]:checked`);
            if (sel) {
                let isRight = (sel.value === 'true');
                studentAns[q.id].display = sel.parentElement.innerText.trim();
                if (isRight) { studentAns[q.id].points = pPerQ; rawScore += pPerQ; }
            }
        } else if (activeMode === 'tf') {
            let count = 0;
            q.shuffledSubs.forEach((s, i) => {
                let sel = document.querySelector(`input[name="${q.id}_${i}"]:checked`);
                let userChoice = sel ? (sel.value === 'true') : null;
                studentAns[q.id].tf_results.push({ text: s.text, correct: s.isCorrect, user: userChoice });
                if (userChoice === true) count++;
            });
            let ratio = [0, 0.1, 0.2, 0.5, 1][count] || 0;
            studentAns[q.id].points = pPerQ * ratio; rawScore += studentAns[q.id].points;
        } else if (activeMode === 'short') {
            let v = document.getElementById(`input_${q.id}`).value.trim();
            studentAns[q.id].val = v;
            if (v.toLowerCase() === q.correct.toLowerCase()) { studentAns[q.id].points = pPerQ; rawScore += pPerQ; }
        }
    });
    document.getElementById('quiz-area').style.display = 'none';
    document.getElementById('result-screen').style.display = 'block';
    document.getElementById('score-text').innerText = (Math.round(rawScore * 10) / 10) + "/10";
}

function renderReview(mode) {
    const div = document.getElementById('review-list'); div.innerHTML = '';
    const list = (mode === 'all') ? parsed[activeMode] : currentQ;
    const maxP = 10 / list.length;

    list.forEach((q, idx) => {
        const ans = studentAns[q.id];
        if (mode === 'correct' && ans.points < maxP * 0.9) return;
        if (mode === 'wrong' && ans.points >= maxP * 0.9) return;

        let html = `<div class="question-item"><p><b>Câu ${q.num}:</b> ${q.q}</p>`;
        if (activeMode === 'choice') {
            q.options.forEach((opt, i) => {
                let cls = (i === q.correct) ? 'correct-ans' : '';
                html += `<div class="${cls}">${String.fromCharCode(65+i)}. ${opt} ${i === q.correct ? '✓' : ''}</div>`;
            });
            html += `<p>Bạn chọn: <span class="${ans.points > 0 ? 'correct-ans' : 'wrong-ans'}">${ans.display || '(Trống)'}</span></p>`;
        } else if (activeMode === 'tf') {
            // Hiển thị lại đúng thứ tự a, b, c, d của đề gốc khi review
            q.sub.forEach((sText, i) => {
                let isRight = q.correct[i];
                // Tìm xem trong lúc làm bài, học sinh đã chọn gì cho ý này
                let work = ans.tf_results.find(r => r.text === sText);
                let userS = (work && work.user !== null) ? (work.user ? 'Đ' : 'S') : '_';
                let check = work ? (work.user === true) : false;
                html += `<div>• ${sText} -> <b class="correct-ans">${isRight?'Đ':'S'}</b> (Bạn: <span class="${check?'':'wrong-ans'}">${userS}</span>)</div>`;
            });
        } else if (activeMode === 'short') {
            html += `<p>Bạn điền: <span class="${ans.points > 0 ? 'correct-ans' : 'wrong-ans'}">${ans.val || '(Trống)'}</span></p>`;
            html += `<p class="correct-ans">Đáp án đúng: ${q.correct}</p>`;
        }
        div.innerHTML += html + `</div>`;
    });
}
parseAll();
</script>
</body>
</html>
